<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±†ç“£å¸–å­æƒ…æ„Ÿåˆ†æå¯è§†åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .chart-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            border-left: 4px solid #667eea;
            padding-left: 15px;
        }
        
        .chart {
            width: 100%;
            height: 400px;
        }
        
        .chart-large {
            height: 500px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2em;
        }
        
        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .refresh-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 20px 0;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š è±†ç“£å¸–å­æƒ…æ„Ÿåˆ†æ</h1>
            <p>å¤šç»´åº¦æƒ…æ„Ÿæ•°æ®å¯è§†åŒ–åˆ†æ</p>
            <button class="refresh-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        </div>
        
        <div id="loading" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="content" style="display: none;">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid" id="statsGrid"></div>
            
            <!-- å›¾è¡¨å®¹å™¨ -->
            <div class="chart-container">
                <div class="chart-title">æ•´ä½“æƒ…æ„Ÿåˆ†å¸ƒ</div>
                <div id="sentimentChart" class="chart"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">æƒ…æ„Ÿå¾—åˆ†åˆ†å¸ƒ</div>
                <div id="scoreChart" class="chart"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">å…³é”®è¯æƒé‡æ’åï¼ˆTop 30ï¼‰</div>
                <div id="keywordChart" class="chart chart-large"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">æ—¶é—´ç»´åº¦æƒ…æ„Ÿå˜åŒ–</div>
                <div id="timeChart" class="chart"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">å¸–å­æƒ…æ„Ÿåˆ†ç±»ç»Ÿè®¡</div>
                <div id="postChart" class="chart"></div>
            </div>
        </div>
    </div>
    
    <script>
        let overallData = null;
        let postsData = null;
        let keywordsData = null;
        
        // åˆå§‹åŒ–
        async function init() {
            try {
                await loadData();
                renderStats();
                renderCharts();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'åŠ è½½æ•°æ®å¤±è´¥: ' + error.message;
            }
        }
        
        // åŠ è½½æ•°æ®
        async function loadData() {
            const [overall, posts, keywords] = await Promise.all([
                fetch('/api/overall').then(r => r.json()),
                fetch('/api/posts').then(r => r.json()),
                fetch('/api/keywords').then(r => r.json())
            ]);
            
            overallData = overall;
            postsData = posts;
            keywordsData = keywords;
        }
        
        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';
            try {
                await fetch('/api/refresh');
                await loadData();
                renderStats();
                renderCharts();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'åˆ·æ–°æ•°æ®å¤±è´¥: ' + error.message;
            }
        }
        
        // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
        function renderStats() {
            const stats = overallData;
            const statsGrid = document.getElementById('statsGrid');
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>æ€»å¸–å­æ•°</h3>
                    <div class="value">${stats.total_posts}</div>
                </div>
                <div class="stat-card">
                    <h3>æ€»è¯„è®ºæ•°</h3>
                    <div class="value">${stats.total_comments}</div>
                </div>
                <div class="stat-card">
                    <h3>å¹³å‡æƒ…æ„Ÿå¾—åˆ†</h3>
                    <div class="value">${stats.avg_sentiment_score.toFixed(3)}</div>
                </div>
                <div class="stat-card">
                    <h3>æ­£é¢å¸–å­</h3>
                    <div class="value">${stats.posts_by_sentiment.positive?.length || 0}</div>
                </div>
                <div class="stat-card">
                    <h3>è´Ÿé¢å¸–å­</h3>
                    <div class="value">${stats.posts_by_sentiment.negative?.length || 0}</div>
                </div>
                <div class="stat-card">
                    <h3>ä¸­æ€§å¸–å­</h3>
                    <div class="value">${stats.posts_by_sentiment.neutral?.length || 0}</div>
                </div>
            `;
        }
        
        // æ¸²æŸ“å›¾è¡¨
        function renderCharts() {
            renderSentimentChart();
            renderScoreChart();
            renderKeywordChart();
            renderTimeChart();
            renderPostChart();
        }
        
        // æƒ…æ„Ÿåˆ†å¸ƒé¥¼å›¾
        function renderSentimentChart() {
            const chart = echarts.init(document.getElementById('sentimentChart'));
            const dist = overallData.sentiment_distribution;
            
            chart.setOption({
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left'
                },
                series: [{
                    name: 'æƒ…æ„Ÿåˆ†å¸ƒ',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 10,
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: true,
                        formatter: '{b}\n{c} ({d}%)'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 20,
                            fontWeight: 'bold'
                        }
                    },
                    data: [
                        { value: dist.positive, name: 'æ­£é¢', itemStyle: { color: '#52c41a' } },
                        { value: dist.negative, name: 'è´Ÿé¢', itemStyle: { color: '#ff4d4f' } },
                        { value: dist.neutral, name: 'ä¸­æ€§', itemStyle: { color: '#faad14' } }
                    ]
                }]
            });
        }
        
        // æƒ…æ„Ÿå¾—åˆ†åˆ†å¸ƒç›´æ–¹å›¾
        function renderScoreChart() {
            const chart = echarts.init(document.getElementById('scoreChart'));
            const scores = postsData.map(p => p.overall_statistics.avg_sentiment_score);
            
            // åˆ†æ¡¶ç»Ÿè®¡
            const bins = Array(20).fill(0);
            scores.forEach(score => {
                const binIndex = Math.min(Math.floor(score * 20), 19);
                bins[binIndex]++;
            });
            
            chart.setOption({
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                xAxis: {
                    type: 'category',
                    data: bins.map((_, i) => (i / 20).toFixed(2)),
                    name: 'æƒ…æ„Ÿå¾—åˆ†'
                },
                yAxis: {
                    type: 'value',
                    name: 'å¸–å­æ•°é‡'
                },
                series: [{
                    name: 'å¸–å­æ•°',
                    type: 'bar',
                    data: bins,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ])
                    }
                }]
            });
        }
        
        // å…³é”®è¯æŸ±çŠ¶å›¾ï¼ˆå› ä¸ºè¯äº‘éœ€è¦é¢å¤–æ’ä»¶ï¼Œæ”¹ç”¨æŸ±çŠ¶å›¾ï¼‰
        function renderKeywordChart() {
            const chart = echarts.init(document.getElementById('keywordChart'));
            const topKeywords = keywordsData.slice(0, 30);
            
            chart.setOption({
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                grid: {
                    left: '15%',
                    right: '10%'
                },
                xAxis: {
                    type: 'value',
                    name: 'æƒé‡'
                },
                yAxis: {
                    type: 'category',
                    data: topKeywords.map(kw => kw.word).reverse(),
                    axisLabel: {
                        interval: 0
                    }
                },
                series: [{
                    name: 'å…³é”®è¯æƒé‡',
                    type: 'bar',
                    data: topKeywords.map(kw => kw.weight).reverse(),
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ])
                    },
                    label: {
                        show: true,
                        position: 'right',
                        formatter: '{c}'
                    }
                }]
            });
        }
        
        // æ—¶é—´ç»´åº¦æƒ…æ„Ÿå˜åŒ–
        function renderTimeChart() {
            const chart = echarts.init(document.getElementById('timeChart'));
            
            // æ”¶é›†æ‰€æœ‰æ—¶é—´æ•°æ®
            const timeData = [];
            postsData.forEach(post => {
                post.time_sentiments.forEach(ts => {
                    timeData.push({
                        time: ts.time,
                        score: ts.score,
                        sentiment: ts.sentiment
                    });
                });
            });
            
            // æŒ‰æ—¶é—´æ’åº
            timeData.sort((a, b) => new Date(a.time) - new Date(b.time));
            
            // åˆ†ç»„ç»Ÿè®¡ï¼ˆæŒ‰å°æ—¶ï¼‰
            const hourlyData = {};
            timeData.forEach(item => {
                const hour = new Date(item.time).toISOString().slice(0, 13);
                if (!hourlyData[hour]) {
                    hourlyData[hour] = { scores: [], count: 0 };
                }
                hourlyData[hour].scores.push(item.score);
                hourlyData[hour].count++;
            });
            
            const hours = Object.keys(hourlyData).sort();
            const avgScores = hours.map(h => {
                const data = hourlyData[h];
                return data.scores.reduce((a, b) => a + b, 0) / data.scores.length;
            });
            
            chart.setOption({
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    type: 'category',
                    data: hours.map(h => h.replace('T', ' ')),
                    axisLabel: { rotate: 45 }
                },
                yAxis: {
                    type: 'value',
                    name: 'å¹³å‡æƒ…æ„Ÿå¾—åˆ†',
                    min: 0,
                    max: 1
                },
                series: [{
                    name: 'æƒ…æ„Ÿå¾—åˆ†',
                    type: 'line',
                    smooth: true,
                    data: avgScores,
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: 'rgba(102, 126, 234, 0.3)' },
                            { offset: 1, color: 'rgba(102, 126, 234, 0.1)' }
                        ])
                    },
                    lineStyle: {
                        color: '#667eea',
                        width: 3
                    }
                }]
            });
        }
        
        // å¸–å­æƒ…æ„Ÿåˆ†ç±»ç»Ÿè®¡
        function renderPostChart() {
            const chart = echarts.init(document.getElementById('postChart'));
            const dist = overallData.posts_by_sentiment;
            
            chart.setOption({
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' }
                },
                xAxis: {
                    type: 'category',
                    data: ['æ­£é¢', 'è´Ÿé¢', 'ä¸­æ€§']
                },
                yAxis: {
                    type: 'value',
                    name: 'å¸–å­æ•°é‡'
                },
                series: [{
                    name: 'å¸–å­æ•°',
                    type: 'bar',
                    data: [
                        dist.positive?.length || 0,
                        dist.negative?.length || 0,
                        dist.neutral?.length || 0
                    ],
                    itemStyle: {
                        color: function(params) {
                            const colors = ['#52c41a', '#ff4d4f', '#faad14'];
                            return colors[params.dataIndex];
                        }
                    },
                    label: {
                        show: true,
                        position: 'top'
                    }
                }]
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        init();
    </script>
</body>
</html>

